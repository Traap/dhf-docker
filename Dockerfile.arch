# ===========================================================================
# 🐧 Dockerfile.arch — DHF Builder (Arch Linux)
# ---------------------------------------------------------------------------
# This image builds Design History File (DHF) documents using LaTeX, Pandoc,
# and Ruby-based automation (docbld, amber, autodoc, tlc-article, etc.).
# It uses a chained multi-stage build to minimize image size:
#   A: TeX Live base
#   B: Ruby + Git for cloning and bundling repos
#   C: Final runtime with all tools available
# ===========================================================================

# ===========================================================================
# CHAIN A: TeX Live (heavy LaTeX dependencies)
# ===========================================================================
FROM archlinux:latest AS texlive

ENV LANG=en_US.UTF-8 \
  LC_ALL=en_US.UTF-8 \
  DEBIAN_FRONTEND=noninteractive

# Refresh mirrors & install TeX Live
RUN \
  pacman -Syu --noconfirm pacman-contrib curl && \
  curl -s "https://archlinux.org/mirrorlist/?country=US&protocol=https&ip_version=4" \
  | sed -e 's/^#Server/Server/' -e '/^#/d' > /etc/pacman.d/mirrorlist && \
  rankmirrors -n 5 /etc/pacman.d/mirrorlist > /etc/pacman.d/mirrorlist.new && \
  mv /etc/pacman.d/mirrorlist.new /etc/pacman.d/mirrorlist && \
  pacman -Syyu --noconfirm && \
  pacman -S --noconfirm \
  texlive-core \
  texlive-latexextra \
  texlive-fontsextra \
  texlive-binextra && \
  pacman -Scc --noconfirm && \
  rm -rf /var/cache/pacman/pkg/*

# Thin layer with TeX only
FROM archlinux:latest AS texlive-base
COPY --from=texlive / /


# ===========================================================================
# CHAIN B: Ruby & Git (repos + bundler)
# ===========================================================================
FROM archlinux:latest AS ruby-base

ENV LANG=en_US.UTF-8 \
  LC_ALL=en_US.UTF-8 \
  DEBIAN_FRONTEND=noninteractive

# Install only ruby & git (lightweight)
RUN \
  pacman -Syu --noconfirm git neovim ruby && \
  pacman -Scc --noconfirm && \
  rm -rf /var/cache/pacman/pkg/*

# ---------------------------------------------------------------------------
# Clone GitHub repositories
# ---------------------------------------------------------------------------
FROM ruby-base AS repos

WORKDIR /soup
RUN \
  git clone --depth=1 https://github.com/Traap/docbld.git && \
  git clone --depth=1 https://github.com/Traap/newdoc.git && \
  git clone --depth=1 https://github.com/Traap/amber.git && \
  git clone --depth=1 https://github.com/Traap/autodoc.git && \
  git clone --depth=1 https://github.com/Traap/tlc-article.git

# ---------------------------------------------------------------------------
# Install Ruby dependencies for docbld + amber
# ---------------------------------------------------------------------------
FROM ruby-base AS rubydeps

# Copy repos in so we can bundle install
COPY --from=repos /soup /soup

# Determine Ruby gem bin path dynamically
ENV PATH="/root/.local/share/gem/ruby/$(ruby -e 'puts RUBY_VERSION[/^\d+\.\d+/]')/bin:$PATH"

WORKDIR /soup
RUN \
  gem install --user-install bundler && \
  for dir in docbld amber; do \
  if [ -f "$dir/Gemfile" ]; then \
  cd "$dir"; \
  bundle install; \
  cd ..; \
  fi; \
  done


# ===========================================================================
# FINAL RUNTIME IMAGE
# ===========================================================================
FROM texlive-base AS runtime

# Install lightweight build tools (non-TeX) + rake + which
RUN \
  pacman -S --noconfirm --needed --overwrite '*' \
  make \
  pandoc \
  python \
  ruby \
  neovim \
  which && \
  gem update --system 3.7.2 && \
  gem install bundler rake && \
  pacman -Scc --noconfirm && \
  rm -rf /var/cache/pacman/pkg/*

RUN gem install rake

RUN RUBY_BIN_DIR="/root/.local/share/gem/ruby/$(ruby -e 'puts RUBY_VERSION[/^\d+\.\d+/]')/bin" \
    && echo "export PATH=$RUBY_BIN_DIR:\$PATH" >> /etc/profile.d/ruby-gems.sh \
    && chmod +x /etc/profile.d/ruby-gems.sh

ENV PATH="/root/.local/share/gem/ruby/3.4.0/bin:${PATH}"

# Copy all repos and Ruby gems
COPY --from=rubydeps /soup /soup

# Locale setup
RUN \
  sed -i 's/^#en_US.UTF-8/en_US.UTF-8/' /etc/locale.gen && \
  locale-gen

WORKDIR /workspace
RUN mkdir -p /exports

VOLUME ["/workspace", "/exports"]

CMD ["make", "all"]

